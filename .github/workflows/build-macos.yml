name: Build and Release (macOS Universal)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # æ„å»ºä¸åŒæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
  build:
    name: Build ${{ matrix.target }}
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
            name: Apple Silicon
          - target: x86_64-apple-darwin
            arch: x64
            name: Intel

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # å®‰è£… Rust å·¥å…·é“¾å’Œç›®æ ‡æ¶æ„
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      # ç¼“å­˜ Rust æ„å»ºäº§ç‰©
      - name: Cache Rust cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Rust cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Rust cargo build
        uses: actions/cache@v4
        with:
          path: src-tauri/target
          key: ${{ runner.os }}-cargo-build-target-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      # å®‰è£… Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # å®‰è£… pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # ç¼“å­˜ Node.js ä¾èµ–
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            src-tauri/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install

      # æ„å»ºåº”ç”¨
      - name: Build Tauri app for ${{ matrix.name }}
        run: |
          pnpm tauri build --target ${{ matrix.target }}
        env:
          TAURI_PRIVATE_KEY: ""
          TAURI_KEY_PASSWORD: ""

      # é‡æ–°ç­¾åï¼ˆad-hoc ç­¾åï¼Œé¿å…æ— æ³•æ‰“å¼€ï¼‰
      - name: Re-sign app bundle
        run: |
          APP_BUNDLE="src-tauri/target/${{ matrix.target }}/release/bundle/macos/etools.app"
          if [ -d "$APP_BUNDLE" ]; then
            echo "é‡æ–°ç­¾å $APP_BUNDLE"
            codesign --force --deep --sign - "$APP_BUNDLE"
            echo "éªŒè¯ç­¾å..."
            codesign -v "$APP_BUNDLE" || true
          fi

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload architecture artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/etools
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app

  # åˆ›å»º Universal Binary
  create_universal:
    name: Create Universal Binary
    needs: build
    runs-on: macos-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰æ¶æ„çš„æ„å»ºäº§ç‰©
      - name: Download all architecture artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # åˆ›å»º Universal Binary
      - name: Create Universal Binary
        run: |
          echo "ğŸğŸ”§ åˆ›å»º Universal Binary (Apple Silicon + Intel)..."

          # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
          find artifacts -type f -name "etools" | head -20
          ls -R artifacts

          # è®¾ç½®å˜é‡
          ARM64_BINARY=$(find artifacts/app-arm64 -type f -name "etools" | head -1)
          X64_BINARY=$(find artifacts/app-x64 -type f -name "etools" | head -1)

          echo "ARM64 binary: $ARM64_BINARY"
          echo "X64 binary: $X64_BINARY"

          if [ ! -f "$ARM64_BINARY" ]; then
            echo "âŒ ARM64 binary not found!"
            exit 1
          fi

          if [ ! -f "$X64_BINARY" ]; then
            echo "âŒ X64 binary not found!"
            exit 1
          fi

          # åˆ›å»ºç›®å½•
          mkdir -p src-tauri/target/universal/release

          # ä½¿ç”¨ lipo åˆå¹¶äºŒè¿›åˆ¶æ–‡ä»¶
          lipo -create \
            "$ARM64_BINARY" \
            "$X64_BINARY" \
            -output src-tauri/target/universal/release/etools

          # éªŒè¯ Universal Binary
          echo "âœ… Universal Binary æ¶æ„ä¿¡æ¯:"
          lipo -info src-tauri/target/universal/release/etools

          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          ls -lh src-tauri/target/universal/release/etools

      # åˆ›å»º Universal .app bundle
      - name: Create Universal .app bundle
        run: |
          echo "ğŸ“¦ åˆ›å»º Universal .app bundle..."

          ARM64_APP=$(find artifacts/app-arm64 -type d -name "etools.app" | head -1)
          UNIVERSAL_APP="src-tauri/target/universal/release/bundle/macos/etools.app"
          UNIVERSAL_BINARY="src-tauri/target/universal/release/etools"

          echo "ARM64 app: $ARM64_APP"

          if [ ! -d "$ARM64_APP" ]; then
            echo "âŒ ARM64 app not found!"
            exit 1
          fi

          # åˆ›å»ºç›®å½•
          mkdir -p "$(dirname "$UNIVERSAL_APP")"

          # å¤åˆ¶ arm64 .app ç»“æ„
          cp -R "$ARM64_APP" "$UNIVERSAL_APP"

          # æ›¿æ¢äºŒè¿›åˆ¶æ–‡ä»¶ä¸º Universal Binary
          cp "$UNIVERSAL_BINARY" "$UNIVERSAL_APP/Contents/MacOS/etools"

          # ç§»é™¤æ‰€æœ‰æ‰©å±•å±æ€§å’Œ quarantine æ ‡å¿—
          xattr -cr "$UNIVERSAL_APP"

          # é‡æ–°ç­¾åï¼ˆad-hocï¼‰
          echo "é‡æ–°ç­¾å Universal app..."
          codesign --force --deep --sign - "$UNIVERSAL_APP"

          # éªŒè¯ç­¾å
          codesign -v "$UNIVERSAL_APP" || echo "ç­¾åéªŒè¯å®Œæˆ"

          # æ˜¾ç¤º .app å¤§å°
          du -sh "$UNIVERSAL_APP"

      # åˆ›å»º Universal DMG
      - name: Create Universal DMG
        run: |
          echo "ğŸ’¿ åˆ›å»º Universal DMG..."

          UNIVERSAL_APP="src-tauri/target/universal/release/bundle/macos/etools.app"
          DMG_DIR="src-tauri/target/universal/release/bundle/dmg"
          mkdir -p "$DMG_DIR"

          # è·å–ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./package.json').version")

          # åˆ›å»ºä¸´æ—¶ç›®å½•ï¼ˆç”¨äºå¹²å‡€çš„ DMGï¼‰
          TEMP_DMG_DIR="dmg_temp"
          mkdir -p "$TEMP_DMG_DIR"
          cp -R "$UNIVERSAL_APP" "$TEMP_DMG_DIR/"

          # æ¸…ç† xattr
          xattr -cr "$TEMP_DMG_DIR/etools.app"

          # åˆ›å»º DMG
          hdiutil create \
            -volname "etools" \
            -srcfolder "$TEMP_DMG_DIR" \
            -ov \
            -format UDZO \
            "$DMG_DIR/etools_${VERSION}_universal.dmg"

          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf "$TEMP_DMG_DIR"

          # æ˜¾ç¤º DMG ä¿¡æ¯
          ls -lh "$DMG_DIR/"*.dmg

      # ä¸Šä¼  Universal æ„å»ºäº§ç‰©
      - name: Upload universal artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: |
            src-tauri/target/universal/release/bundle/macos/*.app
            src-tauri/target/universal/release/bundle/dmg/*.dmg

      # åˆ›å»º GitHub Release
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/universal/release/bundle/dmg/*.dmg
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## ğŸ‰ Universal Binary Release

            æ­¤ç‰ˆæœ¬åŒ…å« **Universal Binary**ï¼ŒåŒæ—¶æ”¯æŒï¼š
            - ğŸ Apple Silicon (M1/M2/M3)
            - ğŸ”§ Intel (x86_64)

            ### ä¸‹è½½å®‰è£…
            ä¸‹è½½ `.dmg` æ–‡ä»¶å¹¶åŒå‡»å®‰è£…å³å¯ã€‚

            ### æ€§èƒ½ä¼˜åŒ–
            - åº”ç”¨å›¾æ ‡åŠ è½½é€Ÿåº¦æå‡ 50-200x
            - æ‰«ææ—¶é—´ä» 5-20 ç§’é™è‡³ <100ms
            - PNG æ ¼å¼æ”¯æŒï¼Œæ›´å¥½çš„æµè§ˆå™¨å…¼å®¹æ€§
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ„å»ºçŠ¶æ€æ£€æŸ¥ï¼ˆä»…å¯¹ PR å’Œæ™®é€š pushï¼‰
      - name: Build summary
        if: "!startsWith(github.ref, 'refs/tags/v')"
        run: |
          echo "âœ… Universal Binary æ„å»ºå®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
          ls -lh src-tauri/target/universal/release/bundle/dmg/ 2>/dev/null || echo "DMG not found"
          ls -lh src-tauri/target/universal/release/bundle/macos/ 2>/dev/null || echo "APP not found"
          echo ""
          echo "ğŸ—ï¸ Universal Binary æ¶æ„:"
          lipo -info src-tauri/target/universal/release/etools 2>/dev/null || echo "Binary not found"
